const http2 = require('http2');
const {
  HTTP2_HEADER_PATH,
  HTTP2_HEADER_METHOD,
  HTTP2_HEADER_STATUS
} = http2.constants;

module.exports = async (port, path, requestHeaders) => {
  return new Promise((resolve, reject) => {
    const client = http2.connect(`https://localhost:${port}`);
    const req = client.request(Object.assign({
      [HTTP2_HEADER_METHOD]: 'GET',
      [HTTP2_HEADER_PATH]: path
    }, requestHeaders || {}));
    let headers = {};
    let body = '';

    req.on('response', (resHeaders) => {
      headers = resHeaders;
    });
    
    req.setEncoding('utf8');
    req.on('data', (d) => body += d);
    req.on('end', (chunk) => {
      req.end();
      resolve({ body, headers });
    });

    req.on('error', (error) => reject(error));
  });
};